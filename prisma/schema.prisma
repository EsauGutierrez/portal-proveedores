// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// --- ENUMERACIONES ---

enum SupplierStatus {
  PENDING
  ACTIVE
  REJECTED
}

enum Role {
  ADMIN
  SUPPLIER
}

enum InvoiceSyncStatus {
  PENDING_SYNC
  SYNCED
  FAILED
}

// NUEVA ENUMERACIÓN: Para el estado de los documentos
enum DocumentStatus {
  PENDING   // Aún no se ha cargado
  UPLOADED  // Cargado y pendiente de revisión
  APPROVED  // Revisado y aprobado
  REJECTED  // Revisado y rechazado
}


// --- MODELOS DE LA APLICACIÓN ---

model User {
  id                  String                @id @default(cuid())
  name                String?
  email               String?               @unique
  password            String?
  role                Role                  @default(SUPPLIER)
  emailVerified       DateTime?
  image               String?
  createdAt           DateTime              @default(now())
  updatedAt           DateTime              @updatedAt
  
  purchaseOrders      PurchaseOrder[]
  invoices            Invoice[]
  paymentComplements  PaymentComplement[]

  supplierProfile     SupplierProfile?
}

model SupplierProfile {
  id            String          @id @default(cuid())
  companyName   String
  rfc           String          @unique
  taxAddress    String
  status        SupplierStatus  @default(PENDING)
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt

  userId        String          @unique
  user          User            @relation(fields: [userId], references: [id])

  subsidiaryId  String
  subsidiary    Subsidiary      @relation(fields: [subsidiaryId], references: [id])

  // CAMBIO: Se añade la relación con los documentos
  documents     SupplierDocument[]
}

// NUEVO MODELO: Para los documentos del proveedor
model SupplierDocument {
  id                String          @id @default(cuid())
  documentType      String          // e.g., 'CONSTANCIA_SITUACION_FISCAL'
  fileName          String
  fileUrl           String
  status            DocumentStatus  @default(PENDING)
  uploadedAt        DateTime        @default(now())
  
  supplierProfileId String
  supplierProfile   SupplierProfile @relation(fields: [supplierProfileId], references: [id])

  @@unique([supplierProfileId, documentType]) // Un proveedor solo puede tener un documento de cada tipo
}


model Subsidiary {
  id            String    @id @default(cuid())
  name          String
  rfc           String    @unique
  businessName  String
  taxRegime     String
  taxAddress    String
  logoUrl       String?
  isActive      Boolean   @default(true)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  purchaseOrders PurchaseOrder[]
  supplierProfiles SupplierProfile[]
}

// ... (El resto de tus modelos no cambian)
model PurchaseOrder {
  id            String      @id @default(cuid())
  folio         String      @unique
  fecha         DateTime
  subtotal      Decimal     @db.Decimal(10, 2)
  total         Decimal     @db.Decimal(10, 2)
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  userId        String
  user          User        @relation(fields: [userId], references: [id])
  subsidiaryId  String
  subsidiary    Subsidiary  @relation(fields: [subsidiaryId], references: [id])
  recepciones   Reception[]
}
model Reception {
  id            String      @id @default(cuid())
  folio         String      @unique
  fecha         DateTime
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  purchaseOrderId String
  purchaseOrder   PurchaseOrder @relation(fields: [purchaseOrderId], references: [id])
  articles      ReceptionArticle[]
  invoice       Invoice?
}
model ReceptionArticle {
  id          String    @id @default(cuid())
  articleName String
  quantity    Int
  unitPrice   Decimal   @db.Decimal(10, 2)
  subtotal    Decimal   @db.Decimal(10, 2)
  tax         Decimal   @db.Decimal(10, 2)
  total       Decimal   @db.Decimal(10, 2)
  receptionId String
  reception   Reception @relation(fields: [receptionId], references: [id])
}
model Invoice {
  id            String      @id @default(cuid())
  folio         String      @unique
  fecha         DateTime
  subtotal      Decimal     @db.Decimal(10, 2)
  total         Decimal     @db.Decimal(10, 2)
  pdfUrl        String?
  xmlUrl        String?
  syncStatus    InvoiceSyncStatus @default(PENDING_SYNC)
  syncError     String?
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  userId        String
  user          User        @relation(fields: [userId], references: [id])
  receptionId   String      @unique
  reception     Reception   @relation(fields: [receptionId], references: [id])
  paymentComplements PaymentComplement[]
}
model PaymentComplement {
  id            String    @id @default(cuid())
  folio         String    @unique
  fecha         DateTime
  total         Decimal   @db.Decimal(10, 2)
  pdfUrl        String?
  xmlUrl        String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  userId        String
  user          User      @relation(fields: [userId], references: [id])
  invoiceId     String
  invoice       Invoice   @relation(fields: [invoiceId], references: [id])
}
